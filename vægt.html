<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Vægtskema</title>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://lipis.github.io/bootstrap-sweetalert/lib/sweet-alert.css">
  <link rel="icon" type="image/png" href="http://i.imgur.com/Fo8GQOM.png">
  <style>
    .form-group {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <br>
  <div class="container-fluid text-center">
    <form id="form" class="form-inline">
      <div class="form-group">
        <label for="user">Person:</label>
        <select class="form-control" id="user" name="user"></select>
      </div>

      <div class="form-group">
        <label for="weight">Vægt i kg:</label>
        <input class="form-control" type="text" placeholder="f.eks. 55.1" id="weight" name="weight">
      </div>

      <div class="form-group">
        <label for="date">Dato:</label>
        <input class="form-control" type="text" placeholder="" id="date" name="date">
      </div>

      <button class="btn btn-success" type="submit">Gem</button>
      <button id="goal" class="btn btn-info" type="button">Opret nyt mål</button>
    </form>

    <div id="highcharts" style="width: 1500px; height: 600px; margin: 10px auto;"></div>

    <div class="col-xs-4" style="float: none; margin: auto;">
      <table class="table table-condensed table-bordered table-striped">
        <thead>
          <tr>
            <th class="text-left">Person</th>
            <th class="text-right">Start vægt</th>
            <th class="text-right">Nuværende</th>
            <th class="text-right">Tab</th>
            <th class="text-right">Næste mål</th>
            <th class="text-right">Til næste mål</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="https://lipis.github.io/bootstrap-sweetalert/lib/sweet-alert.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>

  <script>
    $(function () {
      $('#highcharts').highcharts({
        chart: {
          type: 'spline',
          zoomType: 'xy'
        },

        credits: {
          enabled: false
        },

        title: {
          text: 'Vægt'
        },

        xAxis: {
          type: 'datetime',
          dateTimeLabelFormats: {
            month: '%e. %b',
            year: '%b'
          },
          title: {
            text: "Dato"
          },
          min: Date.UTC(2015, 0, 1),
          max: new Date((Date.now() + 3 * 24 * 3600 * 1000)).valueOf() // 3 days from now
        },

        yAxis: {
          title: {
            text: 'Vægt'
          },
          labels: {
            formatter: function () {
              return this.value + ' kg';
            }
          }
        }
      });
    });
  </script>

  <script>
    Highcharts.createElement('link', {
      href: 'http://fonts.googleapis.com/css?family=Dosis:400,600',
      rel: 'stylesheet',
      type: 'text/css'
    }, null, document.getElementsByTagName('head')[0]);

    Highcharts.theme = {
      colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
               "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
      chart: {
        backgroundColor: null,
        style: {
          fontFamily: "Dosis, sans-serif"
        }
      },
      title: {
        style: {
          fontSize: '16px',
          fontWeight: 'bold',
          textTransform: 'uppercase'
        }
      },
      tooltip: {
        borderWidth: 0,
        backgroundColor: 'rgba(219,219,216,0.8)',
        shadow: false
      },
      legend: {
        itemStyle: {
          fontWeight: 'bold',
          fontSize: '13px'
        }
      },
      xAxis: {
        gridLineWidth: 1,
        title: {
          style: {
            textTransform: 'uppercase'
          }
        },
        labels: {
          style: {
            fontSize: '12px'
          }
        }
      },
      yAxis: {
        minorTickInterval: 'auto',
        title: {
          style: {
            textTransform: 'uppercase'
          }
        },
        labels: {
          style: {
            fontSize: '12px'
          }
        }
      },
      plotOptions: {
        candlestick: {
          lineColor: '#404048'
        }
      },
      // General
      background2: '#F0F0EA'

    };

    // Apply the theme
    Highcharts.setOptions(Highcharts.theme);
  </script>

  <script src="https://cdn.firebase.com/js/client/2.0.6/firebase.js"></script>
  <script>
    function today() {
      var date = new Date;
      var day, month;

      day = date.getDate()
      day = day < 10 ? "0" + day : day;

      month = date.getMonth() + 1
      month = month < 10 ? "0" + month : month;
      return day + "-" + month + "-" + date.getFullYear();
    }

    function parseDate(date) {
      var dateArr = date.split('-');
      var day   = parseInt(dateArr[0]);
      var month = parseInt(dateArr[1]);
      var year  = parseInt(dateArr[2]);
      return Date.UTC(year, month-1, day)
    }

    $(function () {
      var dateElem = document.getElementById("date");
      dateElem.value = today();

      var dataRef = new Firebase("https://intense-inferno-1350.firebaseio.com/weight");

      var option, chartSerie, tableRow, firstWeight, lastWeight, difference, goals, nextGoal, toNextGoal;
      dataRef.child("users").once("value", function(snap) {
        var chart = $("#highcharts").highcharts();

        snap.forEach(function(user) {
          option = document.createElement("option");
          option.text = user.val().name;
          option.value = user.key();
          document.getElementById("user").appendChild(option);

          if (user.val().weight) {
            var serie = {
              name: user.val().name,
              data: $.map(user.val().weight, function(elem) {
                return [[parseDate(elem.date), parseFloat(elem.weight)]];
              }).sort(function(a, b) {
                return a[0] - b[0];
              })
            };

            chartSerie = chart.addSeries(serie);

            tableRow = document.createElement("tr");
            tableRow.id = user.val().name + "-row";
            tableRow.innerHTML  = "<td class='text-left'>" + user.val().name + "</td>";

            firstWeight = parseFloat(serie.data[0][1]);
            tableRow.innerHTML += "<td class='text-right'>" + firstWeight.toFixed(1) + " kg</td>";

            lastWeight = parseFloat(serie.data[serie.data.length - 1][1]);
            tableRow.innerHTML += "<td class='text-right'>" + lastWeight.toFixed(1) + " kg</td>";

            difference = parseFloat(firstWeight - lastWeight);
            tableRow.innerHTML += "<td class='text-right'>" + difference.toFixed(2) + " kg</td>";

            if (user.val().goals) {
              goals = $.map(user.val().goals, function(elem) {
                if (parseDate(elem.date) > new Date()) {
                  return [[parseDate(elem.date), parseFloat(elem.goal)]];
                }
              }).sort(function(a, b) {
                return a[0] - b[0];
              });
              nextGoal = goals[0];
              nextGoalWeight = parseFloat(nextGoal[1])

              tableRow.innerHTML += "<td class='text-right'>" + nextGoalWeight.toFixed(2) + " kg</td>";

              toNextGoal = parseFloat(lastWeight - nextGoalWeight);
              tableRow.innerHTML += "<td class='text-right'>" + toNextGoal.toFixed(2) + " kg</td>";

              if (toNextGoal < 0) {
                tableRow.className = "success";
              }

              chart.addSeries({
                name: user.val().name + " mål",
                data: [serie.data[0], nextGoal],
                color: chartSerie.color,
                symbol: chartSerie.symbol,
                dashStyle: "dot",
                linkedTo: ":previous"
              });
            } else {
              tableRow.innerHTML += "<td></td><td></td>";
            }

            document.getElementById("table-body").appendChild(tableRow);
          }
        })

        var lastUser = localStorage.getItem("lastUser");
        if (lastUser) {
          $("#user").val(lastUser);
        }
      });

      dataRef.child("users").on("child_changed", function(user) {
        var chart = $("#highcharts").highcharts();
        var series = $.grep(chart.series, function(s) {
          return (s.name == user.val().name);
        });
        var goalSerie = $.grep(chart.series, function(s) {
          return (s.name == (user.val().name + " mål"));
        });

        if (series.length > 0) {
          var serie = $.map(user.val().weight, function(elem) {
            return [[parseDate(elem.date), parseFloat(elem.weight)]];
          }).sort(function(a, b) {
            return a[0] - b[0];
          });

          series[0].setData(serie);

          var tableRow = document.createElement("tr");
          tableRow.id = user.val().name + "-row";
          tableRow.innerHTML  = "<td class='text-left'>" + user.val().name + "</td>";

          firstWeight = parseFloat(serie[0][1]);
          tableRow.innerHTML += "<td class='text-right'>" + firstWeight.toFixed(1) + " kg</td>";

          lastWeight = parseFloat(serie[serie.length - 1][1]);
          tableRow.innerHTML += "<td class='text-right'>" + lastWeight.toFixed(1) + " kg</td>";

          difference = parseFloat(firstWeight - lastWeight);
          tableRow.innerHTML += "<td class='text-right'>" + difference.toFixed(2) + " kg</td>";

          if (user.val().goals) {
            goals = $.map(user.val().goals, function(elem) {
              if (parseDate(elem.date) > new Date()) {
                return [[parseDate(elem.date), parseFloat(elem.goal)]];
              }
            }).sort(function(a, b) {
              return a[0] - b[0];
            });
            nextGoal = goals[0];
            nextGoalWeight = parseFloat(nextGoal[1])

            tableRow.innerHTML += "<td class='text-right'>" + nextGoalWeight.toFixed(2) + " kg</td>";

            toNextGoal = parseFloat(lastWeight - nextGoalWeight);
            tableRow.innerHTML += "<td class='text-right'>" + toNextGoal.toFixed(2) + " kg</td>";

            if (toNextGoal < 0) {
              tableRow.className = "success";
            }

            goalSerie[0].setData([serie[0], nextGoal]);
          } else {
            tableRow.innerHTML += "<td></td><td></td>";
          }

          document.getElementById(tableRow.id).innerHTML = tableRow.innerHTML;
        }
      });

      var form = document.getElementById("form");
      form.addEventListener("submit", function(event) {
        if (event.preventDefault) event.preventDefault();
        event.returnValue = false;

        var userId = form.elements["user"].value;
        var weight = form.elements["weight"].value;
        var date   = form.elements["date"].value;

        weight = weight.replace(",", ".");

        if (!date.match(/^\d{2}-\d{2}-\d{4}$/i)) {
          sweetAlert({
            title: "Ups...",
            text: "Det skal være en dato. Skriv f.eks. '03-01-2015'.",
            type: "error",
            allowOutsideClick: true
          });
          return;
        } else if (!weight.toString().match(/^\d+([.,]\d+)?$/i)) {
          sweetAlert({
            title: "Ups...",
            text: "Vægt skal være et tal. Skriv f.eks. '55.1'.",
            type: "error",
            allowOutsideClick: true
          });
          return;
        } else if (weight == "" || date == "") {
          sweetAlert({
            title: "Ups...",
            text: "Mangler data!",
            type: "error",
            allowOutsideClick: true
          });
          return;
        }

        sweetAlert({
          title: "Gemt!",
          timer: 2000,
          type: "success"
        });

        dataRef.child("users/" + userId + "/weight").push({
          date: date,
          weight: weight
        });

        localStorage.setItem("lastUser", userId);
      }, false);

      $("#goal").click(function() {
        var userId     = form.elements["user"].value;
        var weightGoal = form.elements["weight"].value;
        var date       = form.elements["date"].value;

        weightGoal = weightGoal.replace(",", ".");

        if (!date.match(/^\d{2}-\d{2}-\d{4}$/i)) {
          sweetAlert({
            title: "Ups...",
            text: "Det skal være en dato. Skriv f.eks. '03-01-2015'.",
            type: "error",
            allowOutsideClick: true
          });
          return;
        } else if (!weightGoal.toString().match(/^\d+([.,]\d+)?$/i)) {
          sweetAlert({
            title: "Ups...",
            text: "Vægt skal være et tal. Skriv f.eks. '55.1'.",
            type: "error",
            allowOutsideClick: true
          });
          return;
        } else if (weightGoal == "" || date == "") {
          sweetAlert({
            title: "Ups...",
            text: "Mangler data!",
            type: "error",
            allowOutsideClick: true
          });
          return;
        }

        sweetAlert({
          title: "Mål gemt!",
          timer: 2000,
          type: "success"
        });

        dataRef.child("users/" + userId + "/goals").push({
          date: date,
          goal: weightGoal
        });
      });
    });
  </script>
</body>
</html>
